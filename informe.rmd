---
title: Reporte técnico indicando el estado y utilidad de los datos históricos y las
  metodologías estadísticas propuestas para el análisis de datos del POA.
author: "Fernando Pardo Urrutia, Omar Miranda Aranda"
date: "1 de Marzo, 2017"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}

library("knitr")
library("kableExtra")

library("plyr")
library("dplyr")
library("tidyr")
library("ggplot2")
library("stringi")

knitr::opts_chunk$set(echo = TRUE)
```
Consultoría relativa al proyecto Facilitación del proceso de consulta del Proyecto Conservación de la Biodiversidad en el Eje Neovolcánico (COBEN) PN:13.2161.1.001.07.

No. Contrato: 83244688

# Introducción

Se realizará un Análisis Exploratorio de las tablas principales de la base de
datos del SGPOA, debido a que la población objetivo de este análisis son justamente
las actividades registradas en dicha base, por lo que se cuenta con información
completa (no hay que hacer inferencia de ningún tipo).

Después de analizar el contenido de cada tabla, se concluyó que las que contienen
información relevante para este proyecto son las siguientes:

* **tb_direcciones**: catálogo de ANP's y direcciones regionales (general = 1)
* **tb_objetivo/tb_temas/tb_actividades**: tablas de actividades/temas/objetivos
POA. Cada objetivo se compone de varios temas que, a su vez, se componen de varias
actividades.
* **tb_unidades**: catálogo de unidades que se *pueden* utilizar para cada una
de las actividades POA.
* **tb_proyectos**: tabla de proyectos implementados por ANP, año y el tema al
que corresponden.
* **tb_actividad_poa**: tabla de actividades POA *programadas* por una ANP en el
marco de un proyecto, sus unidades y las metas programadas por trimestre.
* **tb_act_trim**: tabla de actividades POA *realizadas* por una ANP, donde se
comparan las metas con los resultados alcanzados para cada trimestre.

```{r tablas, include = FALSE}

tablas <- readRDS(file = "insumos/tablas.rds")

### Después de un análisis, se concluyó que se trabajará con las siguientes
### tablas y variables:

# Catálogo de ANP's
tb_direcciones <- tablas$tb_direcciones %>%
  select(
    id_dir,
    direccion,
    general
  )
    # No nos importan tanto los siguientes campos: Mercedes.
    #general, #si la que captura POA es dirección general o no 
    #complejo, #POA's que capturan más de una ANP
    #activa # si está activa la ANP

# Catálogo de objetivos
tb_objetivo <- tablas$tb_objetivo

# Catálogo de temas asociados a los objetivos
tb_temas <- tablas$tb_temas

# Catálogo de actividades asociadas a los temas
tb_actividades <- tablas$tb_actividades %>%
  select(
    id_act,
    actividad,
    id_tema
  )

# Catálogo de unidades de medida posibles para cada actividad
tb_unidades <- tablas$tb_unidades %>%
  select(
    id_uni,
    unidad,
    id_act,
    dato_part,
    poa_2016
  )

# Tabla de proyectos implementados por ANP, año y tema.
tb_proyecto <- tablas$tb_proyecto %>%
  select(
    id_proy,
    anyo_proy,
    id_tema,
    id_dir,
    obj
  )

# Tabla de actividades planeadas en cada uno de los proyectos anteriores
tb_actividad_poa <- tablas$tb_actividad_poa %>%
  select(
    id_act,
    id_cat_act,
    id_cat_unidad,
    des,
    tipo_meta,
    prog_prim,
    prog_seg,
    prog_ter,
    prog_cua,
    nueva_act,
    nueva_unidad,
    id_proy
  )

# Tabla de seguimiento a las actividades en tb_actividad_poa
tb_act_trim <- tablas$tb_act_trim %>%
  select(
    id_act_trim,
    id_actividad,
    act_1_realizado,
    act_1_programadas,
    act_1_alcanzadas,
    act_1_resultados,
    act_2_realizado,
    act_2_programadas,
    act_2_alcanzadas,
    act_2_resultados,
    act_3_realizado,
    act_3_programadas,
    act_3_alcanzadas,
    act_3_resultados,
    act_4_realizado,
    act_4_programadas,
    act_4_alcanzadas,
    act_4_resultados
  )

## Joins previos al análisis exploratorio

# Catálogo de objetivos, temas y actividades:

Catalogo_general_actividades <- tb_objetivo %>%
  right_join(tb_temas, by = "id_obj") %>%
  right_join(tb_actividades, by = "id_tema")

Catalogo_proyectos_anp_tema <- tb_proyecto %>%
  left_join(
    tb_temas, by = "id_tema"
  ) %>%
  left_join(
    tb_objetivo, by = "id_obj"
  ) %>%
  left_join(
    tb_direcciones, by = "id_dir"
  ) %>%
  select(
    -id_tema,
    -id_dir,
    -id_obj
  )

Actividad_poa <- tb_actividad_poa %>%
  left_join(Catalogo_general_actividades %>%
              select(
                id_act,
                actividad,
                # hay referencias circulares
                tema_cat_actividades = tema,
                objetivo_cat_actividades = objetivo
              ), by = c("id_cat_act" = "id_act")) %>%
  left_join(tb_unidades %>%
              select(
                id_uni,
                unidad,
                dato_part,
                poa_2016
              ), by = c("id_cat_unidad" = "id_uni")) %>%
  left_join(Catalogo_proyectos_anp_tema %>%
      rename(
        tema_cat_proyectos = tema,
        objetivo_cat_proyectos = objetivo
      ), by = "id_proy") %>%
  left_join(tb_act_trim, by = c("id_act" = "id_actividad")) %>%
  transmute(
    id = id_act,
    descripcion = des,
    acumulativa = ifelse(tipo_meta == 1, FALSE, TRUE),
    # revisar qué número corresponde a acumulativa / no acumulativa
    id_actividad = id_cat_act,
    actividad,
    unidad,
    
    realizada_1 = as.logical(act_1_realizado),
    alcanzadas_1 = act_1_alcanzadas,
    meta_1 = prog_prim,
    #meta_1_aux = act_1_programadas,
    
    realizada_2 = as.logical(act_2_realizado),
    alcanzadas_2 = act_2_alcanzadas,
    meta_2 = prog_seg,
    #meta_2_aux = act_2_programadas,
    
    realizada_3 = as.logical(act_3_realizado),
    alcanzadas_3 = act_3_alcanzadas,
    meta_3 = prog_ter,
    #meta_3_aux = act_3_programadas,
    
    realizada_4 = as.logical(act_4_realizado),
    alcanzadas_4 = act_4_alcanzadas,
    meta_4 = prog_cua,
    #meta_4_aux = act_4_programadas,
    
    id_proyecto = id_proy,
    anio = anyo_proy,
    tema = ifelse(!is.na(tema_cat_actividades), tema_cat_actividades, tema_cat_proyectos),
    objetivo = ifelse(!is.na(objetivo_cat_actividades), objetivo_cat_actividades, objetivo_cat_proyectos),
    direccion,
    general
  )

# Revisando que no haya incongruencias entre temas y objetivos obtenidos con ifelse:

unique(Actividad_poa$tema) # Hay NA's
unique(Actividad_poa$objetivo) # Hay NA's

# Perfecto: las actividades sin tema son las que no tienen objetivo

Actividad_poa %>%
  group_by(tema) %>%
  tally() %>%
  nrow() == Actividad_poa %>%
  group_by(tema, objetivo) %>%
  tally() %>%
  nrow()
# Perfecto: no hay actividades con temas iguales bajo distintos objetivos
```

<!--
1. Número de ANP's que ejecutan determinado objetivo / tema por año.
2. Cuántos temas aborda cada ANP por año y objetivo (se liga naturalmente con la anterior)
(por tema se que máximo 1).
Después de explicar la equivalencia entre número de temas abordados por ANP y año, con
número de proyectos ejecutados por ANP y año:
3. Cuántos proyectos ejecuta cada ANP por año.
-->

El análisis exploratorio se dividió en 3 partes, que van de lo general a lo particular:

1. análisis general a nivel de proyectos,
2. análisis a general a nivel de actividades,
3. análisis específico de las actividades prioritarias.

# Análisis general a nivel de proyectos

La primera parte de este análisis exploratorio tendrá como principal
unidad de observación el proyecto, por lo que se enfocará en el estudio de
distintas tendencias de cantidad de proyectos abordados por objetivo, tema,
año y tipo de dirección (ANP o dirección regional).

## Cantidad de ANP's y proyectos que abordan determinado objetivo en cada año.

Empezamos con un análisis destinado a mostrar la importancia de cada objetivo
por año, en términos del número de ANP's y proyectos que abordan cada uno de
estos. La mejor manera de representar estos datos es utilizando una gráfica de
barras, pues no hay dispersión alguna.

```{r, echo = FALSE}
Anps_proyectos_objetivo_anio <- Catalogo_proyectos_anp_tema %>%
  group_by(objetivo, anyo_proy, direccion) %>%
  tally() %>%
  ungroup() %>%
  group_by(objetivo, anyo_proy) %>%
  summarise(
    n = n(),
    tipo = "ANPs"
    ) %>%
  union(
    Catalogo_proyectos_anp_tema %>%
      group_by(objetivo, anyo_proy) %>%
      tally() %>%
      mutate(
        tipo = "Proyectos"
        )
    )
```

```{r, echo=FALSE, fig.width=10, fig.height=11}
ggplot(data = Anps_proyectos_objetivo_anio, aes(x = reorder(objetivo, n), y = n,
  fill = objetivo)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ tipo + anyo_proy) +
  xlab("Objetivos") +
  ylab("Número de ANP's y Direcciones") +
  ggtitle("Número de ANP's/ proyectos por objetivo por año") +
  theme(
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5, face="bold"))
```

Se puede observar que:

* Los objetivos de **"Conservación y Manejo de la Biodiversidad"**,
**"Comunicación ,Educación, Cultura y participación social para la conservación"**
y **"Economía de la conservación"** son los más importantes, tanto por el número
de ANP's que los implementan, como por el número de proyectos que tienen.
* En términos generales, se redujeron la cantidad de ANP's y proyectos que abordan
cada objetivo en el 2016 con respecto al 2015. La excepción es el objetivo **"Manejo
integrado de paisaje"**.
* Es interesante notar que en los años estudiados, la mayoría de los objetivos
mantuvieron su misma posición, al ordenarlos por número de ANP's / proyectos que
los implementan, lo que puede significar que **no hubo un cambio radical de prioridades**
de un año a otro.
* Al comparar el número de proyectos con el número de ANP's por objetivo, podemos
ver que, a nivel de ANP, los objetivos de **"Conservación y Manejo de la Biodiversidad"**,
**"Comunicación ,Educación, Cultura y participación social para la conservación"**
y **"Economía de la conservación"** son los más importantes, puesto que las ANP's
tienden a implementar varios proyectos de cada uno de estos objetivos.

<!-- lo que refleja los principales -->

<!--Coma cada ANP implementa máximo un proyecto por tema por año, el número de
proyectos implementados para un determinado tema en un determinado año, es el
número de ANP's que aborda dicho tema en un determinado año, no así para objetivos -->

## Cantidad de ANP's / proyectos que abordan determinado tema en cada año.

Prosiguiendo con el análisis, decidimos dar un vistazo más detallado a la gráfica
anterior, es decir, obtener el número de proyectos / ANP's que realizan determinado
tema por año.

<!--
Catalogo_proyectos_anp_tema %>%
  group_by(tema, anyo_proy, direccion) %>%
  tally()
-->

Al revisar la base de datos, notamos que cada ANP realiza, a lo más, un proyecto
por tema por año; entonces **el número de proyectos implementados por año para
determinado tema es el número de ANP's que implementaron dicho tema en dicho año**,
por lo tanto, las dos gráficas: **Cantidad de ANP's que implementan un tema por año**
y **Cantidad de proyectos implementados por tema y año** son las mismas:

```{r, echo = FALSE}
Proyectos_tema_anio <- Catalogo_proyectos_anp_tema %>%
  group_by(tema, anyo_proy, objetivo) %>%
  tally()
```

```{r, echo=FALSE, fig.width=12, fig.height=11}
ggplot(data = Proyectos_tema_anio, aes(x = reorder(tema, n), y = n, fill = objetivo)) +
  geom_bar(stat = "identity") +
  facet_wrap(~anyo_proy) +
  xlab("Temas") +
  ylab("Número de proyectos") +
  ggtitle("Número de proyectos/ANP's por año y tema") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    plot.title = element_text(hjust = 0.5, face="bold")
    )
```

Interpretaciones:

* En los años estudiados, los temas mantuvieron casi siempre su misma posición al
ordenarlos por número de proyectos, lo que puede significar que se mantuvieron las
prioridades de un año a otro.
* En general, se observa una reducción del número de proyectos implementados por
tema del año 2016 con respecto al 2015.
* En general, los objetivos con menor importancia (medida con respecto al número
de ANP's y proyectos implementados), tienen un sólo tema, que en general sí es de
interés para las ANP's (**"Atención a los efectos del Cambio Climático y disminución de emisiones de GEI"**, **"Fortalecimiento de la coordinación estratégica intrasectorial (Integralidad)"**, **"Fortalecimiento de la coordinación intersectorial (Transversalidad)"**)
* Por el contrario, los objetivos con mayor importancia tienen varios temas
que, además, son implementados por una gran cantidad de ANP's: notar la cantidad
de temas y proyectos implementados para cada uno, dentro de los objetivos:
**"Conservación y Manejo de la Biodiversidad"**,
**"Comunicación ,Educación, Cultura y participación social para la conservación"**
y **"Economía de la conservación"**.

<!--En la tabla anexa se muestran los temas desglosados por objetivos y
ordenados por cantidad de proyectos (ANP's) totales:

Objetivo,temas,n_2015,n_2016,n_total

* En la tabla se puede apreciar que los temas con más cantidad de proyectos por objetivo
son los siguientes:....
-->

## Número de proyectos (temas) abordados por ANP y dirección regional para cada objetivo y año.

Prosiguiendo con el análisis, ahora resulta interesante preguntarse, en resumen,
cuántos temas aborda por objetivo cada ANP y dirección regional, para los dos 
años de interés. Esto lo lagramos utilizando diagramas de caja y brazos,
puesto que necesitamos **resumir** de alguna manera los datos de cada ANP y
dirección regional en particular.

En estos diagramas por objetivos no se dividió entre ANP's y direcciones regionales
puesto que para direcciones regionales, en general hay muy pocos datos, y es
complejo interpretar varios diagramas de caja que fueron construidos sin mucha
información.

```{r, echo = FALSE}
Proyectos_anp_anio_objetivo <- Catalogo_proyectos_anp_tema %>%
  group_by(anyo_proy, objetivo, direccion) %>%
  summarise(
    n = n()
  ) %>%
  ungroup() %>%
  complete(anyo_proy, objetivo, direccion, fill = list(n = 0))

  # filter(objetivo == "Atención a los efectos del Cambio Climático y disminución de emisiones de   GEI") %>%
  # group_by(anyo_proy) %>%
  #   tally()
```

```{r, echo=FALSE, fig.height=11, fig.width=10}
ggplot(data = Proyectos_anp_anio_objetivo, aes(x = objetivo, y = n,
  colour = objetivo)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.15) +
  facet_wrap(~anyo_proy) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("Objetivos") +
  ylab("Número de temas") +
  ggtitle("Número de temas (proyectos) abordados por objetivo por cada ANP") +
  theme(
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5, face="bold")
    )

# ggplot(data = Proyectos_anp_anio_objetivo, aes(x = n)) +
#   geom_histogram() +
#   facet_wrap(~ anyo_proy + objetivo)
```

Como podemos observar, para ambos años, no se observan diferencias importantes
en los cuartiles de las distribuciones de número de temas (proyectos) implementados
por ANP para cada objetivo, por lo que la disminución general en el número de proyectos
implementados del 2015 al 2016, posiblemente se debe a efectos pequeños agregados,
es decir, a efectos poco perceptibles a nivel de objetivo, pero que pueden salir
a la vista a nivel del total de proyectos por ANP.

Por ejemplo: si cada ANP disminuyó la cantidad de proyectos implementados en 1,
pero repartidos entre objetivos, el impacto se notaría mucho más al no segmentar
los datos por objetivo. Éste será nuestro siguiente análisis.

## Número de proyectos realizados por ANP / dirección regional para cada año

Ligando con la sección pasada, ahora se procede a graficar el número de
proyectos totales realizados por ANP y dirección regional en cada año, utilizando
un diagrama de caja y brazos. Esto ya no es problema con los proyectos agregados,
puesto que se reducirá mucho la cantidad de diagramas de caja por interpretar.
Además, la división entre ANP's y direcciones regionales permitirán capturar
diferencias en las tendencias entre ambos tipos de dirección.

```{r echo = FALSE}
# Histogramas y diagramas de caja de número de proyectos realizados por dirección
# para cada año, dividiendo entre si son de ANP's o de direcciones regionales

Proyectos_anp_anio <- Catalogo_proyectos_anp_tema %>%
  group_by(direccion, anyo_proy) %>%
  summarise(
    n = n(),
    direccion_general = first(general)
  ) %>%
  ungroup() %>%
  mutate(
    etiquetas_direccion_general = ifelse(direccion_general == "0", "ANP", "Dirección regional")
  )
```

```{r, echo=FALSE}
ggplot(data = Proyectos_anp_anio, aes(x = as.character(anyo_proy), y = n, colour = as.character(anyo_proy))) +
  geom_boxplot() +
  facet_wrap(~etiquetas_direccion_general) +
  geom_jitter(aes(y = n), alpha = 0.3) +
  xlab("Años") +
  ylab("Número de proyectos realizados") +
  scale_colour_discrete(name = "Año") +
  ggtitle("Número de proyectos realizados por  ANP's y Dirección Regional en cada año") +
  theme(
    plot.title = element_text(hjust = 0.5, face="bold")
    )
```

Al estudiar la siguiente gráfica, podemos observar que:

* La mediana de proyectos ejecutados
disminuyó del 2015 al 2016 tanto para ANP's como para Direcciones Regionales.
* Las direcciones generales tienden a ejecutar más proyectos y por
lo tanto, a abordar más temas que las ANPs.

# Análisis general a nivel de actividades

La segunda parte de este documento toma como unidades de observación
las actividades programadas y realizadas en el marco de cada proyecto declarado
en el SGPOA, por lo que corresponde a un análisis a un nivel más fino que el anterior.

**Este análisis involucra principalmente la relación entre actividades
y unidades de medida de las mismas**, debido a que este punto es esencial para
lograr una estandarización de los datos capturados, y con ello, poder efectuar
el análisis que sintetice la información de todas las ANP's.

Para estudiar el número de registros comparables dentro
del SGPOA. **Partimos del supuesto que dos registros son comparables cuando forman parte de la misma actividad y tienen la misma unidad de medida.**

Por ejemplo, registros con unidad de medida: **"Hectáreas registradas"**, pero
correspondientes a distintas actividades, como pueden ser:
**"Apoyar a la población local que así lo requiera en los trámites para la incorporación de predios al programa de servicios ambientales de la CONAFOR"** e
**"Implementar instrumentos económicos y/o financieros"** no son inmediatamente
comparables, revisar cuáles sí lo son requeriría de un esfuerzo y entendimiento
de cada una de las actividades, que sale del marco de esta consultoría.

De igual manera, registros correspondientes a la misma actividad, como puede ser
**"Elaborar y ejecutar programas de inspección y vigilancia en las ANP y sus zonas de influencia, para detectar y/o prevenir ilícitos ambientales"**, pero tomados con
unidades de medidas distintas, como pueden ser: **"Hectáreas supervisadas mediante actividades de vigilancia"** y **"Número de comités integrados"** tampoco son comparables entre
ANP's para hacer análisis integrados.

Para los alcances de esta consultoría, registros comparables serían, por ejemplo,
los que corresponden a la actividad: **"Elaborar y ejecutar programas de inspección y vigilancia en las ANP y sus zonas de influencia, para detectar y/o prevenir ilícitos ambientales"**,
con la unidad de medida **"Hectáreas supervisadas mediante actividades de vigilancia"**.
Ya que sabemos que son hectáreas (por lo tanto comparables) entre sí, y con el mismo
fin (por lo tanto, tiene sentido la comparación).

La última aclaración es que registros con unidad de medida **"Número de acciones realizadas"**
no se consideran comparables, ya que una acción puede tener significados distintos
dependiendo del ANP, o incluso de la persona que implementó la actividad. Por
ejemplo, una acción en un ANP puede ser plantar 100 árboles, y en
otra, plantar 1 árbol. Tampoco actividades o unidades de medida **"Otras..."**,
o que no se ligan automáticamente a un tema u objetivo se tomaron en cuenta.

## Número de registros comparables por actividad y unidad de medida

La primera idea que viene a la mente al estudiar las actividades programadas y
realizadas en el marco de esta consultoría es evaluar la comparabilidad de los
registros históricos.

Ésto se puede pensar como la siguiente pregunta: ¿Qué cantidad de registros hay
para cada actividad y unidad de medida?

Como hay varias combinaciones de actividad con unidad de medida, conviene realizar
un diagrama de caja y brazos con esta información, para lograr encontrar resúmenes
de la tendencia y dispersión de los datos.

```{r echo = FALSE}
# Actividades y unidades más realizadas en todo el POA: presentarla como una tabla
Actividades_unidades <- Actividad_poa %>%
  # Homologando actividades iguales con distintos id's
  group_by(actividad) %>%
    mutate(
      id_actividad = first(id_actividad)
    ) %>%
  ungroup %>%
  group_by(actividad, unidad) %>%
    summarise(
      # hay actividades iguales con distintos id's
      id_actividad = first(id_actividad),
      tema = first(tema),
      objetivo = first(objetivo),
      n = n()
    ) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  select(
    id_actividad,
    actividad,
    unidad,
    tema,
    objetivo,
    n
  ) %>%
  arrange(tema, desc(n))

Actividades_unidades_presentable <- Actividades_unidades %>%
  select(
    actividad,
    unidad,
    n
  ) %>%
  arrange(desc(n))

Actividades_unidades_comparables <- Actividades_unidades %>%
  filter(
    !stri_detect_regex(unidad, "acciones|\\.\\.\\.", case_insensitive=TRUE) |
    stri_detect_regex(unidad, "con|proyectos", case_insensitive=TRUE)
  ) %>%
  arrange(desc(n))

#kable(Actividades_unidades_comparables)
```

```{r, echo=FALSE}
ggplot(data = Actividades_unidades_comparables, aes(x = "1", y = n)) +
  geom_boxplot() +
  geom_jitter(aes(y = n), alpha = 0.2) +
  ggtitle("Número de registros por actividad \n con la misma unidad de medida") +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(hjust = 0.5, face="bold")
    )


# Para complementar esta gráfica, graficar qué porcentaje de las actividades
# realizadas pertenecen a actividades + unidades no comparables.
```

En la gráfica anterior se puede observar que el 75% de las combinaciones de
**actividades con unidades de medida comparables, tiene menos de 30 datos**, lo
que impacta en su alcance para hacer análisis estandarizados, utilizando datos
de varias ANP's.

## Gráfica de número mínimo de registros comparables contra porcentaje de registros en la base y combinaciones actividad + unidad que satisfacen ese requerimiento

Un análisis complementario al anterior es revisar qué porcentaje de los registros
en la base, y del total de combinaciones de actividad + unidad, sirven para realizar
análisis que requieran de un **mínimo** registros comparables. Siendo este mínimo
variable.

```{r echo = FALSE}
num_registros_totales <- sum(Actividades_unidades_comparables$n)
num_actividades_unidades_totales <- nrow(Actividades_unidades_comparables)
```

Para cambiar de porcentaje a números absolutos, recordar que en la base hay:

* `r num_registros_totales` registros de actividades programadas y realizadas.
* `r num_actividades_unidades_totales` combinaciones de actividad +
unidad de medida.

Todo esto después de eliminar los registros y actividades + unidades que se
consideraron "incomparables", como se explicó al inicio de esta sección.

```{r echo = FALSE}
Num_registros_comparables_utilidad_base <- Actividades_unidades_comparables %>%
  arrange(n) %>%
  ddply(.(n), function(x){
    data_frame(
      num_registros_comparables = x[1,"n"],
      num_registros = sum(x$n),
      num_actividades_unidades = nrow(x))
  }) %>%
  select(
    num_registros_comparables,
    num_registros,
    num_actividades_unidades
  ) %>%
  mutate(
    num_acum_registros = cumsum(num_registros),
    porcentaje_registros = (num_registros_totales - num_acum_registros + num_registros ) /
        num_registros_totales * 100,
    num_acum_actividades_unidades = cumsum(num_actividades_unidades),
    porcentaje_actividades_unidades = (num_actividades_unidades_totales -
      num_acum_actividades_unidades + num_actividades_unidades) /
      num_actividades_unidades_totales * 100
  ) %>%
  select(
    num_registros_comparables,
    porcentaje_registros,
    porcentaje_actividades_unidades
  ) %>%
  gather(llave, valor, porcentaje_registros, porcentaje_actividades_unidades) %>%
  mutate(
    clave = ifelse(llave == "porcentaje_actividades_unidades",
      "% actividades + unidades", "% registros")
  )
```

```{r, echo=FALSE, fig.height=11, fig.width=10}

# Función para recalcular el número de marcas en el eje X.
number_ticks <- function(n){function(limits) pretty(limits, n)}

ggplot(data = Num_registros_comparables_utilidad_base, aes(
  x = num_registros_comparables, y = valor, colour = clave)) +
  geom_point() +
  geom_line() +
  xlab("Número requerido de registros comparables") +
  ylab("Porcentaje del total en la base") +
  ggtitle("% de registros y actividades + unidades \nen la base que satisfacen un requerimiento mínimo de comparabilidad") +
  theme(
    plot.title = element_text(hjust = 0.5, face="bold")
    ) +
  scale_x_continuous(breaks=number_ticks(30)) +
  scale_y_continuous(breaks=number_ticks(20))
```

La interpretación de esta gráfica se realiza como sigue:

Si, por ejemplo, se requiere saber qué porcentaje de la base de datos se puede
utilizar para efectuar un análisis que requiera de mínimo 30 registros comparables,
la gráfica muestra que el 25% de las combinaciones actividad + unidad son las que
aplican, y entre estas actividades + unidades utilizables, acumulan aproximandamente
el 65% de los registros de actividades programadas en el SGPOA.

Para hacer práctica la información de la gráfica anterior, es útil preguntarse si
las actividades + unidades que tienen mayor cantidad de registros tienden a ser
implementados por una mayor cantidad de áreas naturales protegidas y direcciones
regional (la respuesta intuitiva esperada es sí).

## Correlación entre número de registros de una actividad + unidad y número de ANP's / direcciones regionales que la implementan

La siguiente gráfica de dispersión muestra la relación entre número de ANPs /
direcciones regionales que implementan determinada actividad con cierta unidad,
y el número de registros de la misma. Se eligió una gráfica de dispersión porque
se quiere mostrar si hay algún tipo de correlación entre ambas variables.

```{r, echo = FALSE}
Actividades_unidades_direcciones <- Actividad_poa %>%
  # Homologando actividades iguales con distintos id's
  group_by(actividad) %>%
    mutate(
      id_actividad = first(id_actividad)
    ) %>%
  ungroup %>%
  group_by(actividad, unidad, direccion, anio) %>%
    summarise(
      # hay actividades iguales con distintos id's
      id_actividad = first(id_actividad),
      n = n(),
      tema = first(tema),
      objetivo = first(objetivo)
    ) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  select(
    objetivo,
    tema,
    id_actividad,
    actividad,
    unidad,
    direccion,
    anio,
    n
  ) %>%
  filter(
    !stri_detect_regex(unidad, "acciones|\\.\\.\\.", case_insensitive=TRUE) |
    stri_detect_regex(unidad, "con|proyectos", case_insensitive=TRUE)
  )

# La comparación es cierta si en el group_by se utilizan
#sum(Actividades_unidades_direcciones$n) == sum(Actividades_unidades_comparables$n)

Actividades_unidades_num_direcciones_registros <- Actividades_unidades_direcciones %>%
  group_by(actividad, unidad, anio) %>%
  summarise(
    num_direcciones = n(),
    num_registros = sum(n)
  )

ggplot(Actividades_unidades_num_direcciones_registros, aes(
  x = num_registros, y = num_direcciones, colour = as.factor(anio))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, alpha = 0.2) +
  facet_wrap(~anio) +
  xlab("Número de registros") +
  ylab("Número de direcciones") +
  scale_colour_discrete(name = "Año") +
  ggtitle("Número de registros de cierta actividad + unidad \n vs. el número de direcciones que la implementan") +
  theme(
    plot.title = element_text(hjust = 0.5, face="bold")
    )
```

Se observa una correspondencia casi perfecta entre el número de direcciones y el
número de registros que implementan cierta combinación de actividad + unidad por
año.

Inspeccionando los datos, se llegó a la conclusión de como cada dirección implementa
a lo más un proyecto por tema por año, entonces, en el marco de ese proyecto, sólo
se implementa una actividad con cierta unidad de medida por año.

Es decir, **como la mayoría de las veces las ANP's implementan, a lo más, una combinación de actividad + unidad de medida por año, el número de registros de dicha actividad + unidad de medida en cierto año es el número de ANP's que la implementaron**.

# Análisis específico a nivel de actividades prioritarias

La parte final de este análisis exploratorio trata de las actividades que se
consideraron prioritarias para los fines de esta consultoría, es decir, las
actividades correspondientes a los temas:

* Vigilancia
* Protección contra incendios forestales
* Sanidad forestal
* Restauración de ecosistemas
* Monitoreo biológico
* Manejo y uso sustentable
* Fomento a la investigación científica en ANP

Además actividades relacionadas con los siguiente temas "no oficiales":

* Infraestructura y señalética
* Aprovechamiento sustentable consuntivo y no consuntivo

El enfoque es de evaluación de estas actividades en cuanto a:

* Unidades de medida
* Cantidad de registros comparables.
* Cantidad de ANP's y direcciones regionales que realizan cada actividad de
manera comparable.
* Ejemplos de análisis posibles con registros comparables de cada actividad.

## Número de unidades de medida por actividad prioritaria.

El primer resultado conforma la siguiente tabla, que indica el número de unidades
distintas por actividad prioritaria.

```{r, echo = FALSE}

# Seleccionar actividades correspondientes a temas que nos interesan y hacer el mismo
# diagrama.

temas_prioritarios <- tb_temas %>%
  arrange(id_tema) %>%
  filter(id_tema %in% c(
    5,
    7,
    8,
    9,
    10,
    11,
    15,
    #16, 
    #20,
    22
    #24
  )) %>%
  '$'('tema')

Actividades_temas_prioritarios_unidades_direcciones <- Actividades_unidades_direcciones %>%
  filter(tema %in% temas_prioritarios)

Actividades_otros_temas_unidades_direcciones <- Actividades_unidades_direcciones %>%
  filter(
    id_actividad %in% c(93, 108, 63) | #infraestructura y señalética
      stri_detect_regex(actividad,
        "capacitación de productor|uso sustentable|visitante|uso público",
        case_insensitive=TRUE) # aprovechamiento sustentable consuntivo y no consuntivo
  )

Actividades_prioritarias_unidades_direcciones <- Actividades_temas_prioritarios_unidades_direcciones %>%
  union(Actividades_otros_temas_unidades_direcciones) %>% #unión eliminando duplicados
  arrange(tema, desc(n))

Actividades_prioritarias_num_unidades <- Actividades_prioritarias_unidades_direcciones %>%
  group_by(actividad) %>%
  do(
    data_frame(
      tema = unique(.$tema),
      num_unidades = unique(.$unidad) %>%
        length()
      )
  ) %>%
  ungroup() %>%
  select(
    tema,
    actividad,
    num_unidades
  ) %>%
  arrange(tema)

kable(Actividades_prioritarias_num_unidades, style = 'grid', split.table = Inf)
```

En la tabla anterior, podemos observar que todas las actividades prioritarias
utilizan unidades de medición distintas, excepto **Elaborar e implementar el programa de uso público (turístico)**.

El siguiente análisis profundizará en el análisis de número de registros comparables
y número de ANP's que realizan determinada actividad prioritaria de manera comparable.

## Cantidad máxima de registros comparables por actividad prioritaria vs total de registros

En este momento, resulta interesante mostrar un análisis que permite cuantificar
la importancia de tener registros comparables para cada actividad prioritaria. Éste
compara:

* El número máximo de registros comparables por actividad.
* El número de registros comparables que se tendrían si se tuvieran las unidades estandarizadas (total de registros por actividad).

```{r, echo = FALSE}
Actividades_prioritarias_num_registros <- Actividades_prioritarias_unidades_direcciones %>%
  ddply(.(actividad), function(x){
    data_frame(
      id_actividad = first(x$id_actividad),
      total_registros = sum(x$n),
      max_registros_comparables = x %>%
      group_by(unidad) %>%
        summarise(
          n = sum(n)
        ) %>%
      ungroup() %>%
      '$'(.,n) %>%
      max()
    )
  }) %>%
  mutate(
    diferencia_registros = total_registros - max_registros_comparables
  ) %>%
  arrange(diferencia_registros) %>%
  mutate(
    indice = 1:nrow(.)
  ) %>%
  gather(key = "llave", value = "valor",
    total_registros,
    max_registros_comparables,
    diferencia_registros) %>%
  mutate(
    clave = ifelse(llave == "total_registros", "total de registros",
      ifelse(llave == "max_registros_comparables", "máximo de registros comparables",
       "diferencia"))
  )
```

```{r, echo=FALSE, fig.height=11, fig.width=10}
ggplot(data = Actividades_prioritarias_num_registros, aes(
  x = indice, y = valor, group = clave, colour = clave)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = mean(Actividades_prioritarias_num_registros %>%
      filter(llave == "diferencia_registros") %>%
      '$'(valor))) +
  xlab("Índice de actividad (especial para esta gráfica)") +
  ylab("Número de registros") +
  scale_colour_discrete(name = "Leyenda:") +
  scale_x_continuous(breaks=number_ticks(25)) +
  scale_y_continuous(breaks=number_ticks(20)) +
  ggtitle("Número de registros por actividad") +
  theme(
    plot.title = element_text(hjust = 0.5, face="bold")
    )
```

En la gráfica anterior se puede observar que:

* En promedio (recta horizontal), si las unidades fueran estandarizadas, se
tendrían casi 60 registros comparables más por actividad.
* Sin embargo, dependiendo de la actividad, esta cantidad va de 0 (**Elaborar e implementar el programa de uso público (turístico)**) a 317 (
**Elaborar y ejecutar programas de inspección y vigilancia en las ANP y sus zonas de influencia, para detectar y/o prevenir ilícitos ambientales**).

A continuación se muestra el índice de actividades (este índice es aplicable
sólo a la gráfica anterior, puesto que ordena por "diferencia"):

```{r, echo = FALSE}
# Índice de actividades para entender la gráfica anterior.
Actividades_prioritarias_numero_registros_table <- Actividades_prioritarias_num_registros %>%
  group_by(indice) %>%
    summarise(
      actividad = first(actividad)
    ) %>%
  rename(
    Indice = indice,
    Actividad = actividad
  )

kable(Actividades_prioritarias_numero_registros_table, style = "grid", split.table = Inf)
# pandoc.table(Actividades_prioritarias_numero_registros_comparables_table, split.cells = c("20%","80%"))
```

## Cantidad máxima vs ideal de ANP's y direcciones regionales que realizan una actividad prioritaria de manera estandarizada

El siguiente análisis es análogo al anterior, pero cuantificando para cada actividad prioritaria:

* El número máximo de ANPs y direcciones regionales que realizan cada actividad
 de manera comparable.
* El número de ANPs y direcciones regionales que realizan cada actividad (y por lo tanto,
que podrían entrar en un análisis conjunto si se midiera ésta de manera estandarizada).

```{r, echo = FALSE}
Actividades_prioritarias_num_anps <- Actividades_prioritarias_unidades_direcciones %>%
  ddply(.(actividad), function(x){
    data_frame(
      id_actividad = first(x$id_actividad),
      total_anps = x %>%
        group_by(direccion) %>%
          summarise(
            n = n()
          ) %>%
        ungroup() %>%
        nrow(),
      max_anps_comparables = x %>%
        group_by(unidad, direccion) %>%
          summarise(
            n = n()
          ) %>%
        ungroup() %>%
        group_by(unidad) %>%
          summarise(
            num_anps = n()
          ) %>%
        '$'(.,num_anps) %>%
        as.numeric() %>%
        max()
    )
  }) %>%
  mutate(
    diferencia_anps = total_anps - max_anps_comparables
  ) %>%
  arrange(diferencia_anps) %>%
  mutate(
    indice = 1:nrow(.)
  ) %>%
  gather(key = "llave", value = "valor",
    total_anps,
    max_anps_comparables,
    diferencia_anps) %>%
  mutate(
    clave = ifelse(llave == "total_anps", "total de ANP's y direcciones",
      ifelse(llave == "max_anps_comparables", "máximo de ANPs y direcciones comparables",
        "diferencia"))
  )
```


```{r, echo=FALSE, fig.height=11, fig.width=10}
ggplot(data = Actividades_prioritarias_num_anps, aes(
  x = indice, y = valor, group = clave, colour = clave)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = mean(Actividades_prioritarias_num_anps %>%
      filter(llave == "diferencia_anps") %>%
      '$'(valor))) +
  xlab("Índice de actividad (especial para esta gráfica)") +
  ylab("Número de ANPS y direcciones") +
  scale_colour_discrete(name = "Leyenda:") +
  scale_x_continuous(breaks=number_ticks(25)) +
  scale_y_continuous(breaks=number_ticks(20)) +
  ggtitle("Número de ANPs y direcciones totales \n vs comparables por actividad") +
  theme(
    plot.title = element_text(hjust = 0.5, face="bold")
    )
```

En la gráfica anterior se puede observar que:

* En promedio (recta horizontal), si las unidades fueran estandarizadas,
se podrían comparar más de 13 ANPs y direcciones regionales adicionales por actividad.
* Sin embargo, dependiendo de la actividad, esta cantidad va de 0 (
**Elaborar e implementar el programa de uso público (turístico)**) a 48 (
**Acciones de restauración realizadas con apoyo de programas de subsidio, instituciones académicas, privadas y OSC (construcción de diques, colecta de germoplasma, producción de plantas, reforestaciones, etc.)**)

A continuación se muestra el índice de actividades (este índice es aplicable
sólo a la gráfica anterior, puesto que ordena por "diferencia"):

```{r, echo = FALSE}
# Índice de actividades para entender la gráfica anterior.
Actividades_prioritarias_numero_anps_table <- Actividades_prioritarias_num_anps %>%
  group_by(indice) %>%
    summarise(
      actividad = first(actividad)
    ) %>%
  rename(
    Indice = indice,
    Actividad = actividad
  )

kable(Actividades_prioritarias_numero_anps_table, style = "grid", split.table = Inf)
# pandoc.table(Actividades_prioritarias_numero_registros_comparables_table, split.cells = c("20%","80%"))
```

## Ejemplos de análisis posibles con registros comparables de cada actividad

Finalmente, y a manera de conclusión, 

Posteriormente, nos concentramos en **encontrar dentro de cada tema prioritario, cuáles 
actividades prioritarias y con qué unidades, tienen mayor representabilidad entre ANP's**, 
es decir, que se realizan en la mayor cantidad de ANP's posibles.

**La siguiente tabla resume este análisis, que a su vez apoya la elección de las
actividades a cuantificar y georreferenciar en esta consultoría**.

```{r, echo = FALSE}
# Tabla de unidades de actividades prioritarias utilizadas por el mayor número de ANP's.

Actividades_prioritarias_unidades_anps <- Actividad_poa %>%
  # Homologando actividades iguales con distintos id's
  group_by(actividad) %>%
    mutate(
      id_actividad = first(id_actividad)
    ) %>%
  ungroup() %>%
  group_by(actividad, unidad, direccion) %>%
    summarise(
      id_actividad = first(id_actividad),
      tema = first(tema),
      n = n()
  ) %>%
  ungroup() %>%
  filter(complete.cases(.)) %>%
  select(
    id_actividad,
    actividad,
    unidad,
    tema,
    direccion,
    n
  ) %>%
  # Quedándome con las unidades comparables
  filter(
    !stri_detect_regex(unidad, "acciones|\\.\\.\\.", case_insensitive=TRUE) |
      stri_detect_regex(unidad, "con|proyectos", case_insensitive=TRUE)
  ) %>%
  # Quedándome con actividades prioritarias
  filter(tema %in% temas_prioritarios |
           id_actividad %in% c(93, 108, 63) | #infraestructura y señalética
           stri_detect_regex(actividad,
                             "capacitación de productor|uso sustentable|visitante|uso público",
                             case_insensitive=TRUE) # aprovechamiento sustentable consuntivo y no consuntivo)
  ) %>%
  group_by(actividad, unidad) %>%
    summarise(
      id_actividad = first(id_actividad),
      tema = first(tema),
      num_anps = n()
    ) %>%
  ungroup() %>%
  arrange(tema, actividad, desc(num_anps))

# Obtuve las actividades prioritarias seleccionando de cada tema las 2 que fueron realizadas
# por una mayor cantidad de ANP's.
Actividades_prioritarias_unidades_anps_presentable <- Actividades_prioritarias_unidades_anps %>%
  ddply(~tema, function(x){
    aux <- x %>%
      arrange(desc(num_anps)) %>%
      head(2)
    #print(aux)
    return(aux)
  })

```



```{r, echo = FALSE}
# Seleccionando actividades cuyas metas son comparables y graficándolas.
# Las principales actividades + unidades comparables entre ANP's
# las tenemos en la tabla "Actividades_prioritarias_unidades_anps_presentable"
# el campo de acumulativo no es muy confiable, por lo que se omitió, al menos
# en principio.


# Tabla con los valores de actividad + unidad que nos interesan:
actividades_unidades_interes <- Actividades_prioritarias_unidades_anps_presentable %>%
  select(
    tema,
    actividad,
    unidad
  ) %>%
  mutate(
    id_actividad_unidad = 1:nrow(.)
  )

kable(actividades_unidades_interes, style = "grid", caption = "Actividades + unidades realizadas por la mayor cantidad de ANP's", split.table = Inf)

# Gráfica de metas realizadas y alcanzadas vs tiempo para las actividades + unidades
# de interés, agregada por ANP.

# tentativo: creo que se perdieron actividades porque no tenían bien registrado el año.
Actividades_prioritarias_unidades_realizadas_anp <- Actividad_poa %>%
  filter(!is.na(anio)) %>%
  inner_join(actividades_unidades_interes, by = c("actividad", "unidad")) %>%
  select(
    -realizada_1,
    -realizada_2,
    -realizada_3,
    -realizada_4
    ) %>%
  gather(llave, valor, alcanzadas_1, meta_1, alcanzadas_2, meta_2, alcanzadas_3,
    meta_3, alcanzadas_4, meta_4, na.rm = TRUE) %>%
  separate(llave, c("tipo","trimestre")) %>%
  transmute(
    id_actividad_unidad = id_actividad_unidad,
    actividad = actividad,
    unidad = unidad,
    trimestre = paste0(anio, "_", trimestre),
    tipo = tipo,
    valor = valor
  ) %>%
  group_by(id_actividad_unidad, actividad, unidad, trimestre, tipo) %>%
    summarise(
      n = sum(valor)
    ) %>%
  ungroup %>%
  arrange(id_actividad_unidad, tipo, trimestre) %>%
  # Calculando frecuencias acumulativas
  group_by(id_actividad_unidad, tipo) %>%
    mutate(
      cum_n = cumsum(n)
    ) %>%
  ungroup()
```

## Actividades con metas comparables

Ahora bien, agregando por ANP's, seleccionamos actividades con metas comparables y
**graficamos por trimestre la meta agregada (en las unidades correspondientes)
VS la cantidad de unidades alcanzadas**.

<!-- Cabe destacar que no utilizamos el campo de "acumulativo", porque nos dimos cuenta
que su información no es muy confiable, al comparar con lo que sabemos de las
juntas, para las 4 ANP's de interés. 
#eoma: Esto ¿por que?
-->

### Por Trimestre

```{r echo=FALSE, fig.height=11, fig.width=10}
# graficando el número de unidades alcanzadas por actividad por trimestre.
ggplot(data = Actividades_prioritarias_unidades_realizadas_anp,
  aes(x = trimestre, y = n, group = tipo, colour = tipo)) +
  geom_point() +
  geom_line(alpha = 0.5) +
  facet_wrap(~id_actividad_unidad, scales = "free") +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(hjust = 0.5, face="bold"))
```

### Acumulado

```{r, echo=FALSE, fig.height=11, fig.width=10}
# y acumulativo:
ggplot(data = Actividades_prioritarias_unidades_realizadas_anp,
  aes(x = trimestre, y = cum_n, group = tipo, colour = tipo)) +
  geom_point() +
  geom_line(alpha = 0.5) +
  facet_wrap(~id_actividad_unidad, scales = "free") +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    #axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(hjust = 0.5, face="bold")
    )
```